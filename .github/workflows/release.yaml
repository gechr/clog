name: release

on:
  push:
    tags:
      - 'v[0-9]*.[0-9]*.[0-9]*'

permissions: {}

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Check for existing tags on this commit
        run: |
          COMMIT=$(git rev-list -n1 "$TAG")
          OTHER_TAGS=$(git tag --points-at "$COMMIT" | grep -v "^${TAG}$" | grep '^v[0-9]' || true)
          if [ -n "$OTHER_TAGS" ]; then
            echo "::error::Commit $COMMIT already has version tag(s): $OTHER_TAGS"
            exit 1
          fi
        env:
          TAG: ${{ github.ref_name }}

      - name: Release
        run: |
          PREV_TAG=$(git tag --sort=-version:refname | grep -A1 "^${TAG}$" | tail -1)
          if [ "$PREV_TAG" = "$TAG" ]; then
            NOTES=$(git log --oneline --format="- %h %s" "$TAG")
          else
            NOTES=$(git log --oneline --format="- %h %s" "${PREV_TAG}..${TAG}")
          fi
          NOTES=$(printf "### Changes\n\n%s" "$NOTES")
          gh release create --repo="$GH_REPO" "$TAG" --notes "$NOTES"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          TAG: ${{ github.ref_name }}
